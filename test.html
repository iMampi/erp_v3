<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <input type="text" name="" id="test">
    <input type="text" name="" id="test2" data-min="0" data-max="100">
    <span id="insert">none</span>
</body>
<script>
    const validNonCharInput = ["Backspace","Enter","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Delete",","];

function formatedNumberToFloat(val) {
	if ((val) && (typeof val == "string")) {
		// NOTE : there is option to use replaceAll, but too recent
		let x = val.split(" ").join("");
		x = x.split(String.fromCharCode(160)).join("");
		x = x.split(String.fromCharCode(8199)).join("");
		x = x.split(String.fromCharCode(8239)).join("");
		x = x.split(String.fromCharCode(8288)).join("");
		let y = x.replace(",", ".");
		return parseFloat(y);
	} else if ((val) && (typeof val == "number")) {
		return parseFloat(val);
	} else {
		// throw new Error("args is not a string");
		return 0.00
	}
}

// function validateNumberTextInput(keyevent) {
//     // caching

//     if(validNonCharInput.includes(keyevent.key)){
//         return true;
//     }
//     let position = event.location;
//     var intialValue = event.target.value.slice();
//     // insert input where it should
//     let test=intialValue.slice(0,position)+event.key+intialValue.slice(position);
//     test=test.trim();
//     // get rid of thousands separators
//     test = test.replace(/\s/g, '');

//     // Validate the input
//     var regex = /^(?:\d+|\d*,\d{0,2})$/;
//     let testeur=!regex.test(test);
//     console.log("testeur : "+testeur);
//     if (testeur) {
//         event.preventDefault();
//         // event.target.value=intialValue;
//         return false;
//     }
//     return true;
// }
function validateNumberTextInput(event) {
    // caching

    if(validNonCharInput.includes(event.data)){
        return true;
    }
    let position = event.target.selectionStart;
    var intialValue = event.target.value.slice();
    // insert input where it should
    let test=intialValue.slice(0,position)+event.data+intialValue.slice(position);
    test=test.trim();
    // get rid of thousands separators
    test = test.replace(/\s/g, '');

    // Validate the input
    var regex = /^(?:\d+|\d*,\d{0,2})$/;
    let testeur=!regex.test(test);
    console.log("testeur : "+testeur);
    if (testeur) {
        event.preventDefault();
        // event.target.value=intialValue;
        return false;
    }
    // event.target.value=test;
    return true;
}

function formatNumberForTextInput(inputTarget,text) {
    text = text.replace(/\s/g, '');
    var parts = text.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    inputTarget.value = parts.join(',');
}

function validateAndFormatNumberTextInput(input) {
    // caching
    let position = input.target.selectionStart;
    var intialValue = input.target.value.slice();
    // insert input where it should
    let test=intialValue.slice(0,position)+input.data+intialValue.slice(position);
    test=test.trim();
    // get rid of thousands separators
    test = test.replace(/\s/g, '');

    // Validate the input
    var regex = /^(?:\d+|\d*,\d{0,2})$/;
    if (!regex.test(test)) {
        return;
    }
    // Format the input with thousand separators
    var parts = test.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    input.target.value = parts.join(',');
}
// function validateAndFormatNumberTextInput(input) {
//     // caching
//     let position = input.target.selectionStart;
//     var intialValue = input.target.value.slice();
//     // insert input where it should
//     let test=intialValue.slice(0,position)+input.data+intialValue.slice(position);
//     test=test.trim();
//     // get rid of thousands separators
//     test = test.replace(/\s/g, '');

//     // Validate the input
//     var regex = /^(?:\d+|\d*,\d{0,2})$/;
//     if (!regex.test(test)) {
//         return;
//     }
//     // Format the input with thousand separators
//     var parts = test.split(',');
//     parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
//     input.target.value = parts.join(',');
// }

// function validateAndFormatNumberWithMinMaxTextInput(input,min=0,max) {
//     // caching
//     let position = input.target.selectionStart;
//     var intialValue = input.target.value.slice();
//     // insert input where it should
//     let test=intialValue.slice(0,position)+input.data+intialValue.slice(position);
//     test=test.trim();
//     // get rid of thousands separators
//     test = test.replace(/\s/g, '');

//     // test max
//     let flagGTMax=false;
//     if (max){
//         flagGTMax=!(formatedNumberToFloat(test)<=max);
//     }

//     // Validate the input
//     var regex = /^(?:\d+|\d*,\d{0,2})$/;
//     let t1=!regex.test(test);
//     let t2;
//     let t3;
//     if (!regex.test(test) || !(formatedNumberToFloat(test)>=min)  || flagGTMax) {
//         return;
//     }
//     // Format the input with thousand separators
//     var parts = test.split(',');
//     parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
//     input.target.value = parts.join(',');
// }

function validateAndFormatNumberWithMinMaxTextInput(input,min=0,max) {
    input.preventDefault();

    // caching
    let position = input.target.selectionStart;
    // deep copy current input value
    var intialValue = input.target.value.slice();
    // insert input where it should
    let test=intialValue.slice(0,position)+input.data+intialValue.slice(position);
    test=test.trim();
    // get rid of thousands separators
    test = test.replace(/\s/g, '');

    // test max
    let flagGTMax=false;
    if (max){
        flagGTMax=!(formatedNumberToFloat(test)<=max);
    }

    // Validate the input
    var regex = /^(?:\d+|\d*,\d{0,2})$/;
    let t1=!regex.test(test);
    let t2;
    let t3;
    if (!regex.test(test) || !(formatedNumberToFloat(test)>=min)  || flagGTMax) {
        console.log("init : "+intialValue);
        input.target.value=intialValue;
        return;
    }
    // Format the input with thousand separators
    var parts = test.split(',');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    input.target.value = parts.join(',');
}


// document.getElementById("test").addEventListener("keydown",(event)=>{
document.getElementById("test").addEventListener("beforeinput",(event)=>{
console.log(event);
if(event.inputType==="insertText"){
    validateNumberTextInput(event);
}
});

document.getElementById("test").addEventListener("input",(event)=>{
console.log(event);
formatNumberForTextInput(event.target,event.target.value);

document.getElementById("insert").textContent=event.target.value;
console.log("tong ianay");
});

document.getElementById("test2").addEventListener("beforeinput",(event)=>{
console.log(event);
if(event.inputType==="insertText"){
    // event.preventDefault();
    validateAndFormatNumberWithMinMaxTextInput(event,document.getElementById("test2").dataset.min,document.getElementById("test2").dataset.max);
    console.log(event.data);
}
})

document.getElementById("test2").addEventListener("input",(event)=>{
console.log("22");
document.getElementById("insert").textContent=event.target.value
},true)
</script>
</html>